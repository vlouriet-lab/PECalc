<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PE-Calc (Final)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        * { box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: #ffffff;
            color: #1a1a1a;
            padding: 16px;
            margin: 0;
            line-height: 1.6;
        }
        
        .wrapper { 
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(124, 58, 237, 0.08);
            border: 1px solid #e9d5ff;
        }
        
        h2 { margin: 0 0 8px 0; color: #6b21a8; font-size: 24px; font-weight: 800; }
        .subtitle { color: #9333ea; font-size: 13px; margin-bottom: 24px; font-weight: 500; }
        
        .controls { 
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e9d5ff;
        }
        
        .control-item { display: flex; flex-direction: column; }
        
        .month-selector { display: grid; grid-template-columns: 2fr 1fr; gap: 12px; }
        
        label { 
            font-size: 11px; font-weight: 700; margin-bottom: 8px; 
            color: #7c3aed; text-transform: uppercase; 
        }
        
        input, select { 
            width: 100%; padding: 12px; border: 2px solid #e9d5ff; 
            border-radius: 8px; font-family: inherit;
        }
        
        .btn-calc { 
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #7c3aed 0%, #9333ea 100%);
            color: white; border: none; padding: 14px;
            font-weight: 700; cursor: pointer; border-radius: 8px;
            text-transform: uppercase; transition: all 0.3s;
        }
        
        .btn-calc:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(124, 58, 237, 0.35); }

        .info-panel { 
            display: grid; grid-template-columns: 2fr 1fr 1fr; 
            gap: 16px; margin-bottom: 20px;
        }
        
        .owner-box { 
            padding: 16px; background: #faf5ff; border: 2px solid #e9d5ff; 
            border-radius: 12px; color: #6b21a8; font-size: 13px; font-weight: 600;
        }
        
        .stat-box { 
            background: #faf5ff; padding: 16px; border-radius: 12px; 
            text-align: right; border: 2px solid #e9d5ff;
        }
        
        .stat-val { font-size: 24px; font-weight: 800; color: #6b21a8; display: block; }
        .tax-box .stat-val { color: #a21caf; }

        #logArea { 
            width: 100%; height: 120px; background: #1e1333; color: #c084fc;
            font-family: monospace; font-size: 11px; padding: 12px;
            overflow-y: auto; border-radius: 12px; margin-top: 20px;
        }

        .table-container { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; background: #7c3aed; color: white; padding: 12px; }
        td { padding: 12px; border-bottom: 1px solid #f3e8ff; }
        .hl-amount { font-weight: 700; color: #6b21a8; }
    </style>
</head>
<body>

<div class="wrapper">
    <h2>üá¨üá™ PE-Calc</h2>
    <div class="subtitle">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –Ω–∞–ª–æ–≥–∞ 1% (BoG Excel / TBC PDF)</div>
    
    <div class="controls">
        <div class="control-item">
            <label>1. –ë–∞–Ω–∫</label>
            <select id="bankSelect">
                <option value="bog">Bank of Georgia (.xlsx)</option>
                <option value="tbc">TBC Bank (.pdf)</option>
            </select>
        </div>
        <div class="control-item">
            <label>2. –ü–µ—Ä–∏–æ–¥</label>
            <div class="month-selector">
                <select id="monthSelect">
                    <option value="01">–Ø–Ω–≤–∞—Ä—å</option><option value="02">–§–µ–≤—Ä–∞–ª—å</option>
                    <option value="03">–ú–∞—Ä—Ç</option><option value="04">–ê–ø—Ä–µ–ª—å</option>
                    <option value="05">–ú–∞–π</option><option value="06">–ò—é–Ω—å</option>
                    <option value="07">–ò—é–ª—å</option><option value="08">–ê–≤–≥—É—Å—Ç</option>
                    <option value="09">–°–µ–Ω—Ç—è–±—Ä—å</option><option value="10">–û–∫—Ç—è–±—Ä—å</option>
                    <option value="11">–ù–æ—è–±—Ä—å</option><option value="12">–î–µ–∫–∞–±—Ä—å</option>
                </select>
                <select id="yearSelect"></select>
            </div>
        </div>
        <div class="control-item">
            <label>3. –§–∞–π–ª –≤—ã–ø–∏—Å–∫–∏</label>
            <input type="file" id="fileInput">
        </div>
        <button class="btn-calc" onclick="startProcess()">üöÄ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
    </div>

    <div class="info-panel">
        <div class="owner-box" id="ownerDisplay">üë§ –í–ª–∞–¥–µ–ª–µ—Ü: <b>(–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω)</b></div>
        <div class="stat-box"><small>–î–û–•–û–î (GEL)</small><span class="stat-val" id="totalGEL">0.00</span></div>
        <div class="stat-box tax-box"><small>–ù–ê–õ–û–ì 1% (GEL)</small><span class="stat-val" id="totalTax">0.00</span></div>
    </div>

    <div id="logArea">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ...</div>

    <div class="table-container">
        <table id="resTable">
            <thead>
                <tr><th>–î–∞—Ç–∞</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–°—É–º–º–∞</th><th>–ö—É—Ä—Å</th><th>–ò—Ç–æ–≥–æ (GEL)</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PDF.js
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    let currentExcelData = null; // –î–∞–Ω–Ω—ã–µ –¥–ª—è BoG
    let currentPdfFile = null;   // –î–∞–Ω–Ω—ã–µ –¥–ª—è TBC

    // –û–ë–©–ò–ô –°–ü–ò–°–û–ö –§–ò–õ–¨–¢–†–û–í (–û–±—ä–µ–¥–∏–Ω–∏–ª –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –∏ –≥—Ä—É–∑–∏–Ω—Å–∫–∏–µ —Å—Ç–æ–ø-—Å–ª–æ–≤–∞)
    const STOP_WORDS = [
        "conversion", "exchange", "loan", "disbursement", 
        "transfer to own", "refund", "electronic till", 
        "·Éô·Éù·Éú·Éï·Éî·É†·É¢·Éê·É™·Éò·Éê", "·Éí·Éê·Éì·Éê·É†·Éò·É™·ÉÆ·Éï·Éê ·É°·Éê·Éô·É£·Éó·Éê·É†", "atm withdrawal", "service fee"
    ];

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–æ–¥–æ–≤
    const ys = document.getElementById('yearSelect');
    const cy = new Date().getFullYear();
    for(let y=cy; y>=cy-5; y--) {
        let opt = document.createElement('option'); opt.value = y; opt.textContent = y; ys.appendChild(opt);
    }
    document.getElementById('monthSelect').value = String(new Date().getMonth() + 1).padStart(2, '0');

    function log(msg) {
        const div = document.createElement('div'); div.innerHTML = `> ${msg}`;
        const area = document.getElementById('logArea');
        area.appendChild(div); area.scrollTop = area.scrollHeight;
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        if (file.name.toLowerCase().endsWith('.pdf')) {
            currentPdfFile = file;
            currentExcelData = null;
            log(`PDF –≤—ã–±—Ä–∞–Ω: ${file.name}`);
            // –ü—ã—Ç–∞–µ–º—Å—è —Å—Ä–∞–∑—É –Ω–∞–π—Ç–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –≤ PDF –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
            await findTbcOwnerAndLog(file);
        } else {
            const reader = new FileReader();
            reader.onload = (event) => {
                const data = new Uint8Array(event.target.result);
                currentExcelData = XLSX.read(data, {type: 'array', cellDates: true});
                currentPdfFile = null;
                // –ò—â–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ –º–µ—Ç–æ–¥–æ–º BoG
                const owner = findBogOwner(currentExcelData);
                document.getElementById('ownerDisplay').innerHTML = `üë§ –í–ª–∞–¥–µ–ª–µ—Ü: <b>${owner || "–ù–µ –Ω–∞–π–¥–µ–Ω"}</b>`;
                log("Excel –∑–∞–≥—Ä—É–∂–µ–Ω.");
            };
            reader.readAsArrayBuffer(file);
        }
    });

    async function startProcess() {
        const bank = document.getElementById('bankSelect').value;
        const m = document.getElementById('monthSelect').value;
        const y = document.getElementById('yearSelect').value;

        if (bank === 'tbc') {
            if (!currentPdfFile) return alert("–ó–∞–≥—Ä—É–∑–∏—Ç–µ PDF —Ñ–∞–π–ª!");
            await processTBC(m, y);
        } else {
            if (!currentExcelData) return alert("–ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel —Ñ–∞–π–ª!");
            await processBoG(m, y);
        }
    }

    // ==========================================
    // –õ–û–ì–ò–ö–ê BOG (EXCEL) - –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ê –ò–ó PE-Calc (1).html
    // ==========================================
    async function processBoG(month, year) {
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫–∏ –≤ —á–∏—Å–ª–∞ –¥–ª—è Date
        const m = parseInt(month);
        const y = parseInt(year);
        const dateFrom = new Date(y, m - 1, 1);
        const dateTo = new Date(y, m, 0, 23, 59, 59);

        const tbody = document.querySelector('#resTable tbody');
        tbody.innerHTML = '';
        let totalGEL = 0;
        
        const ownerName = findBogOwner(currentExcelData);
        
        let sheetName = currentExcelData.SheetNames.find(n => n.toLowerCase().includes('trans')) || currentExcelData.SheetNames[1];
        if (!sheetName) sheetName = currentExcelData.SheetNames[0];
        
        log(`BoG –ê–Ω–∞–ª–∏–∑ –ª–∏—Å—Ç–∞: "${sheetName}"`);
        const rows = XLSX.utils.sheet_to_json(currentExcelData.Sheets[sheetName], {header: 1});

        let col = { date: -1, desc: -1, gel: -1, usd: -1, eur: -1 };
        let startIdx = 0;

        // –ü–æ–∏—Å–∫ —Å—Ç—Ä–æ–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (–∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ)
        for(let i=0; i<Math.min(rows.length, 25); i++) {
            const r = rows[i].map(c => String(c || '').toLowerCase());
            if (r.some(c => c.includes('date')) && r.some(c => c.includes('amount') || c.includes('gel'))) {
                col.date = r.findIndex(c => c.includes('date'));
                col.desc = r.findIndex(c => c.includes('detail') || c.includes('desc') || c.includes('–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ'));
                col.gel = r.indexOf('gel');
                col.usd = r.indexOf('usd');
                col.eur = r.indexOf('eur');
                
                // Fallback –¥–ª—è CSV BoG
                if (col.gel === -1) { col.gel = 3; col.usd = 4; col.eur = 5; }
                startIdx = i + 1;
                break;
            }
        }

        for (let i = startIdx; i < rows.length; i++) {
            const row = rows[i];
            let dateVal = row[col.date];
            if (!dateVal) continue;

            let dateObj = null;
            if (dateVal instanceof Date) dateObj = dateVal;
            else if (typeof dateVal === 'string') {
                const parts = dateVal.split(/[\/\.]/);
                if (parts.length === 3) dateObj = new Date(parts[2], parts[1]-1, parts[0]);
            }
            if (!dateObj || isNaN(dateObj)) continue;
            
            // –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ
            if (dateObj < dateFrom || dateObj > dateTo) continue;

            const rawDesc = String(row[col.desc] || '');
            const desc = rawDesc.toLowerCase();

            // –§–∏–ª—å—Ç—Ä—ã
            if (STOP_WORDS.some(w => desc.includes(w))) continue;
            if (ownerName && rawDesc.toUpperCase().includes(ownerName)) continue;

            // –î–µ–Ω—å–≥–∏
            const monies = [
                { val: parseMoney(row[col.gel]), code: 'GEL' },
                { val: parseMoney(row[col.usd]), code: 'USD' },
                { val: parseMoney(row[col.eur]), code: 'EUR' }
            ];

            for (let money of monies) {
                if (money.val > 0) {
                    const rate = await getRate(dateObj, money.code);
                    const sumGEL = money.val * rate;
                    totalGEL += sumGEL;
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${dateObj.toLocaleDateString()}</td>
                            <td>${rawDesc.substring(0, 50)}</td>
                            <td>${money.val} ${money.code}</td>
                            <td>${rate.toFixed(4)}</td>
                            <td class="hl-amount">${sumGEL.toFixed(2)}</td>
                        </tr>`;
                }
            }
        }
        updateTotals(totalGEL);
    }

    // ==========================================
    // –õ–û–ì–ò–ö–ê TBC (PDF) - –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø
    // ==========================================
    async function processTBC(targetMonth, targetYear) {
        const pdf = await pdfjsLib.getDocument(await currentPdfFile.arrayBuffer()).promise;
        let totalGEL = 0;
        const tbody = document.querySelector('#resTable tbody');
        tbody.innerHTML = '';
        log("TBC: –ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É PDF...");

        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            const items = content.items;

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É Paid In –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            let paidInX = 0;
            const header = items.find(it => it.str.includes("Paid In") || it.str.includes("·É®·Éî·Éõ·Éù·É°·É£·Éö·Éò"));
            if (header) paidInX = header.transform[4];

            for (let j = 0; j < items.length; j++) {
                const str = items[j].str.trim();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞—Ç—É (dd/mm/yyyy)
                if (/^\d{2}\/\d{2}\/\d{4}$/.test(str)) {
                    const parts = str.split('/');
                    if (parts[1] === targetMonth && parts[2] === targetYear) {
                        
                        const currentY = items[j].transform[5];
                        let desc = (items[j+1]?.str || "") + " " + (items[j+2]?.str || "");
                        let income = 0;

                        // –ò—â–µ–º —Å—É–º–º—É —Å—Ç—Ä–æ–≥–æ –≤ –∫–æ–ª–æ–Ω–∫–µ Paid In (–ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–µ X)
                        // –°–∫–∞–Ω–∏—Ä—É–µ–º —Å–ª–µ–¥—É—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã –º–∞—Å—Å–∏–≤–∞ items
                        for (let k = j + 1; k < j + 30 && k < items.length; k++) {
                            const it = items[k];
                            // –ü—Ä–æ–≤–µ—Ä–∫–∞: —ç–ª–µ–º–µ–Ω—Ç –Ω–∞ —Ç–æ–π –∂–µ —Å—Ç—Ä–æ–∫–µ (Y) –∏ –≤ –∫–æ–ª–æ–Ω–∫–µ Paid In (X)
                            const isSameLine = Math.abs(it.transform[5] - currentY) < 5;
                            const isPaidInCol = paidInX > 0 && Math.abs(it.transform[4] - paidInX) < 60;
                            
                            if (isSameLine && isPaidInCol) {
                                let val = it.str.replace(/,/g, '');
                                if (!isNaN(val) && parseFloat(val) > 0) {
                                    income = parseFloat(val);
                                    break; 
                                }
                            }
                        }

                        if (income > 0 && !STOP_WORDS.some(w => desc.toLowerCase().includes(w.toLowerCase()))) {
                            totalGEL += income;
                            tbody.innerHTML += `
                                <tr>
                                    <td>${str}</td>
                                    <td>${desc.substring(0,60)}</td>
                                    <td>${income.toFixed(2)} GEL</td>
                                    <td>1.0000</td>
                                    <td class="hl-amount">${income.toFixed(2)}</td>
                                </tr>`;
                        }
                    }
                }
            }
        }
        updateTotals(totalGEL);
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞ TBC
    async function findTbcOwnerAndLog(file) {
        try {
            const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
            const page = await pdf.getPage(1);
            const content = await page.getTextContent();
            const items = content.items;
            
            for (let i = 0; i < items.length; i++) {
                const text = items[i].str.trim();
                if (text.includes("Account Holder:") || text.includes("·Éê·Éú·Éí·Éê·É†·Éò·É®·Éò·É° ·Éõ·É§·Éö·Éù·Éë·Éî·Éö·Éò:")) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ª–µ–¥—É—é—â–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –ø–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–º –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç (–∏–º—è)
                    for (let k=1; k<=5; k++) {
                        const nextText = items[i+k]?.str.trim();
                        if (nextText && nextText.length > 2) {
                            document.getElementById('ownerDisplay').innerHTML = `üë§ –í–ª–∞–¥–µ–ª–µ—Ü: <b>${nextText}</b>`;
                            log(`–ù–∞–π–¥–µ–Ω –≤–ª–∞–¥–µ–ª–µ—Ü: ${nextText}`);
                            return;
                        }
                    }
                }
            }
        } catch(e) {}
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è BoG
    function findBogOwner(wb) {
        let ds = wb.Sheets["Details"] || wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ds, {header: 1});
        for(let row of rows) {
            const str = row.map(c => String(c || '').toLowerCase());
            if (str.some(c => c.includes('account owner') || c.includes('–≤–ª–∞–¥–µ–ª–µ—Ü'))) {
                for(let i=1; i<row.length; i++) {
                    if (row[i] && String(row[i]).length > 3) return String(row[i]).toUpperCase();
                }
            }
        }
        return null;
    }

    // –ü–∞—Ä—Å–µ—Ä –¥–µ–Ω–µ–≥ –∏–∑ BoG (–≤–∞–∂–Ω–æ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã)
    function parseMoney(val) {
        if (typeof val === 'number') return val;
        return val ? parseFloat(String(val).replace(/,/g, '')) : 0;
    }

    function updateTotals(total) {
        document.getElementById('totalGEL').innerText = total.toFixed(2);
        document.getElementById('totalTax').innerText = (total * 0.01).toFixed(2);
        log("–†–∞—Å—á–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω.");
    }

    // –ö—ç—à –∏ API –∫—É—Ä—Å–æ–≤
    let cache = {};
    async function getRate(date, curr) {
        if (curr === 'GEL') return 1;
        const dStr = date.toISOString().split('T')[0];
        if (cache[dStr+curr]) return cache[dStr+curr];
        try {
            const url = `https://api.allorigins.win/get?url=${encodeURIComponent('https://nbg.gov.ge/gw/api/ct/monetarypolicy/currencies/en/json/?date=' + dStr)}`;
            const res = await fetch(url);
            const json = await res.json();
            const data = JSON.parse(json.contents);
            const found = data[0].currencies.find(c => c.code === curr);
            cache[dStr+curr] = found ? (found.rate / found.quantity) : 1;
            return cache[dStr+curr];
        } catch { return 1; }
    }
</script>
</body>
</html>